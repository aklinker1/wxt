import { describe, it, expect } from 'vitest';
import { TestProject } from '../utils';

describe('Output Directory Structure', () => {
  it('should not output hidden files and directories that start with "."', async () => {
    const project = new TestProject();
    project.addFile('entrypoints/.DS_Store');
    project.addFile('entrypoints/.hidden1/index.html');
    project.addFile('entrypoints/.hidden2.html');

    await project.build();

    expect(await project.serializeOutput()).toMatchInlineSnapshot(`
      ".output/chrome-mv3/manifest.json
      ----------------------------------------
      {\\"manifest_version\\":3,\\"name\\":\\"E2E Extension\\",\\"description\\":\\"Example description\\",\\"version\\":\\"0.0.0\\",\\"version_name\\":\\"0.0.0-test\\"}"
    `);
  });

  it('should output separate CSS files for each content script', async () => {
    const project = new TestProject();
    project.addFile(
      'entrypoints/one.content/index.ts',
      `import './style.css';
      export default defineContentScript({
        matches: ["*://*/*"],
        main: () => {},
      })`,
    );
    project.addFile(
      'entrypoints/one.content/style.css',
      `body { color: blue }`,
    );
    project.addFile(
      'entrypoints/two.content/index.ts',
      `import './style.css';
      export default defineContentScript({
        matches: ["*://*/*"],
        main: () => {},
      })`,
    );
    project.addFile('entrypoints/two.content/style.css', `body { color: red }`);

    await project.build();

    expect(await project.serializeOutput()).toMatchInlineSnapshot(`
      ".output/chrome-mv3/assets/one.css
      ----------------------------------------
      body{color:#00f}

      ================================================================================
      .output/chrome-mv3/assets/two.css
      ----------------------------------------
      body{color:red}

      ================================================================================
      .output/chrome-mv3/content-scripts/one.js
      ----------------------------------------
      var ae=Object.defineProperty;var me=(m,a,l)=>a in m?ae(m,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):m[a]=l;var G=(m,a,l)=>(me(m,typeof a!=\\"symbol\\"?a+\\"\\":a,l),l),V=(m,a,l)=>{if(!a.has(m))throw TypeError(\\"Cannot \\"+l)};var Z=(m,a,l)=>(V(m,a,\\"read from private field\\"),l?l.call(m):a.get(m)),N=(m,a,l)=>{if(a.has(m))throw TypeError(\\"Cannot add the same private member more than once\\");a instanceof WeakSet?a.add(m):a.set(m,l)};var $=(m,a,l)=>(V(m,a,\\"access private method\\"),l);(function(){var h,k,E,z,S,Y;\\"use strict\\";function m(i){return i}const a=\\"\\",l={matches:[\\"*://*/*\\"],main:()=>{}};var H=typeof globalThis<\\"u\\"?globalThis:typeof window<\\"u\\"?window:typeof global<\\"u\\"?global:typeof self<\\"u\\"?self:{};function K(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,\\"default\\")?i.default:i}var O={exports:{}};(function(i,p){(function(g,c){c(i)})(typeof globalThis<\\"u\\"?globalThis:typeof self<\\"u\\"?self:H,function(g){var c,x;if(!((x=(c=globalThis.chrome)==null?void 0:c.runtime)!=null&&x.id))throw new Error(\\"This script should only be loaded in a browser extension.\\");if(typeof globalThis.browser>\\"u\\"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const w=\\"The message port closed before a response was received.\\",re=v=>{const R={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(R).length===0)throw new Error(\\"api-metadata.json has not been included in browser-polyfill\\");class B extends WeakMap{constructor(r,n=void 0){super(n),this.createItem=r}get(r){return this.has(r)||this.set(r,this.createItem(r)),super.get(r)}}const se=e=>e&&typeof e==\\"object\\"&&typeof e.then==\\"function\\",q=(e,r)=>(...n)=>{v.runtime.lastError?e.reject(new Error(v.runtime.lastError.message)):r.singleCallbackArg||n.length<=1&&r.singleCallbackArg!==!1?e.resolve(n[0]):e.resolve(n)},P=e=>e==1?\\"argument\\":\\"arguments\\",ne=(e,r)=>function(t,...A){if(A.length<r.minArgs)throw new Error(\`Expected at least \${r.minArgs} \${P(r.minArgs)} for \${e}(), got \${A.length}\`);if(A.length>r.maxArgs)throw new Error(\`Expected at most \${r.maxArgs} \${P(r.maxArgs)} for \${e}(), got \${A.length}\`);return new Promise((u,d)=>{if(r.fallbackToNoCallback)try{t[e](...A,q({resolve:u,reject:d},r))}catch(s){console.warn(\`\${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: \`,s),t[e](...A),r.fallbackToNoCallback=!1,r.noCallback=!0,u()}else r.noCallback?(t[e](...A),u()):t[e](...A,q({resolve:u,reject:d},r))})},D=(e,r,n)=>new Proxy(r,{apply(t,A,u){return n.call(A,e,...u)}});let M=Function.call.bind(Object.prototype.hasOwnProperty);const I=(e,r={},n={})=>{let t=Object.create(null),A={has(d,s){return s in e||s in t},get(d,s,f){if(s in t)return t[s];if(!(s in e))return;let o=e[s];if(typeof o==\\"function\\")if(typeof r[s]==\\"function\\")o=D(e,e[s],r[s]);else if(M(n,s)){let y=ne(s,n[s]);o=D(e,e[s],y)}else o=o.bind(e);else if(typeof o==\\"object\\"&&o!==null&&(M(r,s)||M(n,s)))o=I(o,r[s],n[s]);else if(M(n,\\"*\\"))o=I(o,r[s],n[\\"*\\"]);else return Object.defineProperty(t,s,{configurable:!0,enumerable:!0,get(){return e[s]},set(y){e[s]=y}}),o;return t[s]=o,o},set(d,s,f,o){return s in t?t[s]=f:e[s]=f,!0},defineProperty(d,s,f){return Reflect.defineProperty(t,s,f)},deleteProperty(d,s){return Reflect.deleteProperty(t,s)}},u=Object.create(e);return new Proxy(u,A)},_=e=>({addListener(r,n,...t){r.addListener(e.get(n),...t)},hasListener(r,n){return r.hasListener(e.get(n))},removeListener(r,n){r.removeListener(e.get(n))}}),te=new B(e=>typeof e!=\\"function\\"?e:function(n){const t=I(n,{},{getContent:{minArgs:0,maxArgs:0}});e(t)}),W=new B(e=>typeof e!=\\"function\\"?e:function(n,t,A){let u=!1,d,s=new Promise(T=>{d=function(b){u=!0,T(b)}}),f;try{f=e(n,t,d)}catch(T){f=Promise.reject(T)}const o=f!==!0&&se(f);if(f!==!0&&!o&&!u)return!1;const y=T=>{T.then(b=>{A(b)},b=>{let L;b&&(b instanceof Error||typeof b.message==\\"string\\")?L=b.message:L=\\"An unexpected error occurred\\",A({__mozWebExtensionPolyfillReject__:!0,message:L})}).catch(b=>{console.error(\\"Failed to send onMessage rejected reply\\",b)})};return y(o?f:s),!0}),ie=({reject:e,resolve:r},n)=>{v.runtime.lastError?v.runtime.lastError.message===w?r():e(new Error(v.runtime.lastError.message)):n&&n.__mozWebExtensionPolyfillReject__?e(new Error(n.message)):r(n)},U=(e,r,n,...t)=>{if(t.length<r.minArgs)throw new Error(\`Expected at least \${r.minArgs} \${P(r.minArgs)} for \${e}(), got \${t.length}\`);if(t.length>r.maxArgs)throw new Error(\`Expected at most \${r.maxArgs} \${P(r.maxArgs)} for \${e}(), got \${t.length}\`);return new Promise((A,u)=>{const d=ie.bind(null,{resolve:A,reject:u});t.push(d),n.sendMessage(...t)})},ge={devtools:{network:{onRequestFinished:_(te)}},runtime:{onMessage:_(W),onMessageExternal:_(W),sendMessage:U.bind(null,\\"sendMessage\\",{minArgs:1,maxArgs:3})},tabs:{sendMessage:U.bind(null,\\"sendMessage\\",{minArgs:2,maxArgs:3})}},F={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return R.privacy={network:{\\"*\\":F},services:{\\"*\\":F},websites:{\\"*\\":F}},I(v,ge,R)};g.exports=re(chrome)}else g.exports=globalThis.browser})})(O);var J=O.exports;const Q=K(J);function C(i,...p){if(typeof p[0]==\\"string\\"){const g=p.shift();i(\`[wxt] \${g}\`,...p)}else i(\\"[wxt]\\",...p)}var j={debug:(...i)=>C(console.debug,...i),log:(...i)=>C(console.log,...i),warn:(...i)=>C(console.warn,...i),error:(...i)=>C(console.error,...i)},X=Q,ee=(h=class extends AbortController{constructor(g){super();N(this,E);N(this,S);N(this,k,window.self===window.top);this.contentScriptName=g,Z(this,k)&&$(this,E,z).call(this),this.setTimeout(()=>{$(this,S,Y).call(this)})}get isInvalid(){return X.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(g){return this.signal.addEventListener(\\"abort\\",g),()=>this.signal.removeEventListener(\\"abort\\",g)}setInterval(g,c){const x=setInterval(()=>{this.isValid&&g()},c);return this.onInvalidated(()=>clearInterval(x)),x}setTimeout(g,c){const x=setTimeout(()=>{this.isValid&&g()},c);return this.onInvalidated(()=>clearTimeout(x)),x}requestAnimationFrame(g){const c=requestAnimationFrame((...x)=>{this.isValid&&g(...x)});return this.onInvalidated(()=>cancelAnimationFrame(c)),c}requestIdleCallback(g,c){const x=requestIdleCallback((...w)=>{this.signal.aborted||g(...w)},c);return this.onInvalidated(()=>cancelIdleCallback(x)),x}notifyInvalidated(){this.abort(\\"Content script context invalidated\\"),j.debug(\`\${this.contentScriptName} invalidated\`)}},k=new WeakMap,E=new WeakSet,z=function(){window.postMessage({event:h.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName})},S=new WeakSet,Y=function(){const g=c=>{var x,w;((x=c.data)==null?void 0:x.type)===h.SCRIPT_STARTED_MESSAGE_TYPE&&((w=c.data)==null?void 0:w.contentScriptName)===this.contentScriptName&&this.notifyInvalidated()};addEventListener(\\"message\\",g),this.onInvalidated(()=>removeEventListener(\\"message\\",g))},G(h,\\"SCRIPT_STARTED_MESSAGE_TYPE\\",\\"wxt:content-script-started\\"),h);(async()=>{try{const i=new ee(\\"one\\");await l.main(i)}catch(i){j.error(\\"The content script crashed on startup!\\",i)}})()})();

      ================================================================================
      .output/chrome-mv3/content-scripts/two.js
      ----------------------------------------
      var ae=Object.defineProperty;var me=(m,a,l)=>a in m?ae(m,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):m[a]=l;var G=(m,a,l)=>(me(m,typeof a!=\\"symbol\\"?a+\\"\\":a,l),l),V=(m,a,l)=>{if(!a.has(m))throw TypeError(\\"Cannot \\"+l)};var Z=(m,a,l)=>(V(m,a,\\"read from private field\\"),l?l.call(m):a.get(m)),N=(m,a,l)=>{if(a.has(m))throw TypeError(\\"Cannot add the same private member more than once\\");a instanceof WeakSet?a.add(m):a.set(m,l)};var $=(m,a,l)=>(V(m,a,\\"access private method\\"),l);(function(){var h,k,E,z,S,Y;\\"use strict\\";function m(i){return i}const a=\\"\\",l={matches:[\\"*://*/*\\"],main:()=>{}};var H=typeof globalThis<\\"u\\"?globalThis:typeof window<\\"u\\"?window:typeof global<\\"u\\"?global:typeof self<\\"u\\"?self:{};function K(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,\\"default\\")?i.default:i}var O={exports:{}};(function(i,p){(function(g,c){c(i)})(typeof globalThis<\\"u\\"?globalThis:typeof self<\\"u\\"?self:H,function(g){var c,x;if(!((x=(c=globalThis.chrome)==null?void 0:c.runtime)!=null&&x.id))throw new Error(\\"This script should only be loaded in a browser extension.\\");if(typeof globalThis.browser>\\"u\\"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const w=\\"The message port closed before a response was received.\\",re=v=>{const R={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(R).length===0)throw new Error(\\"api-metadata.json has not been included in browser-polyfill\\");class B extends WeakMap{constructor(r,n=void 0){super(n),this.createItem=r}get(r){return this.has(r)||this.set(r,this.createItem(r)),super.get(r)}}const se=e=>e&&typeof e==\\"object\\"&&typeof e.then==\\"function\\",q=(e,r)=>(...n)=>{v.runtime.lastError?e.reject(new Error(v.runtime.lastError.message)):r.singleCallbackArg||n.length<=1&&r.singleCallbackArg!==!1?e.resolve(n[0]):e.resolve(n)},P=e=>e==1?\\"argument\\":\\"arguments\\",ne=(e,r)=>function(t,...A){if(A.length<r.minArgs)throw new Error(\`Expected at least \${r.minArgs} \${P(r.minArgs)} for \${e}(), got \${A.length}\`);if(A.length>r.maxArgs)throw new Error(\`Expected at most \${r.maxArgs} \${P(r.maxArgs)} for \${e}(), got \${A.length}\`);return new Promise((u,d)=>{if(r.fallbackToNoCallback)try{t[e](...A,q({resolve:u,reject:d},r))}catch(s){console.warn(\`\${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: \`,s),t[e](...A),r.fallbackToNoCallback=!1,r.noCallback=!0,u()}else r.noCallback?(t[e](...A),u()):t[e](...A,q({resolve:u,reject:d},r))})},D=(e,r,n)=>new Proxy(r,{apply(t,A,u){return n.call(A,e,...u)}});let M=Function.call.bind(Object.prototype.hasOwnProperty);const I=(e,r={},n={})=>{let t=Object.create(null),A={has(d,s){return s in e||s in t},get(d,s,f){if(s in t)return t[s];if(!(s in e))return;let o=e[s];if(typeof o==\\"function\\")if(typeof r[s]==\\"function\\")o=D(e,e[s],r[s]);else if(M(n,s)){let y=ne(s,n[s]);o=D(e,e[s],y)}else o=o.bind(e);else if(typeof o==\\"object\\"&&o!==null&&(M(r,s)||M(n,s)))o=I(o,r[s],n[s]);else if(M(n,\\"*\\"))o=I(o,r[s],n[\\"*\\"]);else return Object.defineProperty(t,s,{configurable:!0,enumerable:!0,get(){return e[s]},set(y){e[s]=y}}),o;return t[s]=o,o},set(d,s,f,o){return s in t?t[s]=f:e[s]=f,!0},defineProperty(d,s,f){return Reflect.defineProperty(t,s,f)},deleteProperty(d,s){return Reflect.deleteProperty(t,s)}},u=Object.create(e);return new Proxy(u,A)},_=e=>({addListener(r,n,...t){r.addListener(e.get(n),...t)},hasListener(r,n){return r.hasListener(e.get(n))},removeListener(r,n){r.removeListener(e.get(n))}}),te=new B(e=>typeof e!=\\"function\\"?e:function(n){const t=I(n,{},{getContent:{minArgs:0,maxArgs:0}});e(t)}),W=new B(e=>typeof e!=\\"function\\"?e:function(n,t,A){let u=!1,d,s=new Promise(T=>{d=function(b){u=!0,T(b)}}),f;try{f=e(n,t,d)}catch(T){f=Promise.reject(T)}const o=f!==!0&&se(f);if(f!==!0&&!o&&!u)return!1;const y=T=>{T.then(b=>{A(b)},b=>{let L;b&&(b instanceof Error||typeof b.message==\\"string\\")?L=b.message:L=\\"An unexpected error occurred\\",A({__mozWebExtensionPolyfillReject__:!0,message:L})}).catch(b=>{console.error(\\"Failed to send onMessage rejected reply\\",b)})};return y(o?f:s),!0}),ie=({reject:e,resolve:r},n)=>{v.runtime.lastError?v.runtime.lastError.message===w?r():e(new Error(v.runtime.lastError.message)):n&&n.__mozWebExtensionPolyfillReject__?e(new Error(n.message)):r(n)},U=(e,r,n,...t)=>{if(t.length<r.minArgs)throw new Error(\`Expected at least \${r.minArgs} \${P(r.minArgs)} for \${e}(), got \${t.length}\`);if(t.length>r.maxArgs)throw new Error(\`Expected at most \${r.maxArgs} \${P(r.maxArgs)} for \${e}(), got \${t.length}\`);return new Promise((A,u)=>{const d=ie.bind(null,{resolve:A,reject:u});t.push(d),n.sendMessage(...t)})},ge={devtools:{network:{onRequestFinished:_(te)}},runtime:{onMessage:_(W),onMessageExternal:_(W),sendMessage:U.bind(null,\\"sendMessage\\",{minArgs:1,maxArgs:3})},tabs:{sendMessage:U.bind(null,\\"sendMessage\\",{minArgs:2,maxArgs:3})}},F={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return R.privacy={network:{\\"*\\":F},services:{\\"*\\":F},websites:{\\"*\\":F}},I(v,ge,R)};g.exports=re(chrome)}else g.exports=globalThis.browser})})(O);var J=O.exports;const Q=K(J);function C(i,...p){if(typeof p[0]==\\"string\\"){const g=p.shift();i(\`[wxt] \${g}\`,...p)}else i(\\"[wxt]\\",...p)}var j={debug:(...i)=>C(console.debug,...i),log:(...i)=>C(console.log,...i),warn:(...i)=>C(console.warn,...i),error:(...i)=>C(console.error,...i)},X=Q,ee=(h=class extends AbortController{constructor(g){super();N(this,E);N(this,S);N(this,k,window.self===window.top);this.contentScriptName=g,Z(this,k)&&$(this,E,z).call(this),this.setTimeout(()=>{$(this,S,Y).call(this)})}get isInvalid(){return X.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(g){return this.signal.addEventListener(\\"abort\\",g),()=>this.signal.removeEventListener(\\"abort\\",g)}setInterval(g,c){const x=setInterval(()=>{this.isValid&&g()},c);return this.onInvalidated(()=>clearInterval(x)),x}setTimeout(g,c){const x=setTimeout(()=>{this.isValid&&g()},c);return this.onInvalidated(()=>clearTimeout(x)),x}requestAnimationFrame(g){const c=requestAnimationFrame((...x)=>{this.isValid&&g(...x)});return this.onInvalidated(()=>cancelAnimationFrame(c)),c}requestIdleCallback(g,c){const x=requestIdleCallback((...w)=>{this.signal.aborted||g(...w)},c);return this.onInvalidated(()=>cancelIdleCallback(x)),x}notifyInvalidated(){this.abort(\\"Content script context invalidated\\"),j.debug(\`\${this.contentScriptName} invalidated\`)}},k=new WeakMap,E=new WeakSet,z=function(){window.postMessage({event:h.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName})},S=new WeakSet,Y=function(){const g=c=>{var x,w;((x=c.data)==null?void 0:x.type)===h.SCRIPT_STARTED_MESSAGE_TYPE&&((w=c.data)==null?void 0:w.contentScriptName)===this.contentScriptName&&this.notifyInvalidated()};addEventListener(\\"message\\",g),this.onInvalidated(()=>removeEventListener(\\"message\\",g))},G(h,\\"SCRIPT_STARTED_MESSAGE_TYPE\\",\\"wxt:content-script-started\\"),h);(async()=>{try{const i=new ee(\\"two\\");await l.main(i)}catch(i){j.error(\\"The content script crashed on startup!\\",i)}})()})();

      ================================================================================
      .output/chrome-mv3/manifest.json
      ----------------------------------------
      {\\"manifest_version\\":3,\\"name\\":\\"E2E Extension\\",\\"description\\":\\"Example description\\",\\"version\\":\\"0.0.0\\",\\"version_name\\":\\"0.0.0-test\\",\\"content_scripts\\":[{\\"matches\\":[\\"*://*/*\\"],\\"css\\":[\\"assets/one.css\\",\\"assets/two.css\\"],\\"js\\":[\\"content-scripts/one.js\\",\\"content-scripts/two.js\\"]}]}"
    `);
  });

  it('should allow inputs with invalid JS variable names, like dashes', async () => {
    const project = new TestProject();
    project.addFile(
      'entrypoints/overlay-one.content.ts',
      `export default defineContentScript({
        matches: ["*://*/*"],
        main: () => {},
      })`,
    );

    await project.build();

    expect(await project.serializeOutput()).toMatchInlineSnapshot(`
      ".output/chrome-mv3/content-scripts/overlay-one.js
      ----------------------------------------
      var ge=Object.defineProperty;var ae=(m,g,l)=>g in m?ge(m,g,{enumerable:!0,configurable:!0,writable:!0,value:l}):m[g]=l;var G=(m,g,l)=>(ae(m,typeof g!=\\"symbol\\"?g+\\"\\":g,l),l),V=(m,g,l)=>{if(!g.has(m))throw TypeError(\\"Cannot \\"+l)};var Z=(m,g,l)=>(V(m,g,\\"read from private field\\"),l?l.call(m):g.get(m)),N=(m,g,l)=>{if(g.has(m))throw TypeError(\\"Cannot add the same private member more than once\\");g instanceof WeakSet?g.add(m):g.set(m,l)};var $=(m,g,l)=>(V(m,g,\\"access private method\\"),l);(function(){var h,k,E,z,S,Y;\\"use strict\\";function m(i){return i}const g={matches:[\\"*://*/*\\"],main:()=>{}};var l=typeof globalThis<\\"u\\"?globalThis:typeof window<\\"u\\"?window:typeof global<\\"u\\"?global:typeof self<\\"u\\"?self:{};function H(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,\\"default\\")?i.default:i}var O={exports:{}};(function(i,p){(function(a,c){c(i)})(typeof globalThis<\\"u\\"?globalThis:typeof self<\\"u\\"?self:l,function(a){var c,x;if(!((x=(c=globalThis.chrome)==null?void 0:c.runtime)!=null&&x.id))throw new Error(\\"This script should only be loaded in a browser extension.\\");if(typeof globalThis.browser>\\"u\\"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const w=\\"The message port closed before a response was received.\\",ee=v=>{const R={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(R).length===0)throw new Error(\\"api-metadata.json has not been included in browser-polyfill\\");class B extends WeakMap{constructor(r,n=void 0){super(n),this.createItem=r}get(r){return this.has(r)||this.set(r,this.createItem(r)),super.get(r)}}const re=e=>e&&typeof e==\\"object\\"&&typeof e.then==\\"function\\",q=(e,r)=>(...n)=>{v.runtime.lastError?e.reject(new Error(v.runtime.lastError.message)):r.singleCallbackArg||n.length<=1&&r.singleCallbackArg!==!1?e.resolve(n[0]):e.resolve(n)},P=e=>e==1?\\"argument\\":\\"arguments\\",se=(e,r)=>function(t,...A){if(A.length<r.minArgs)throw new Error(\`Expected at least \${r.minArgs} \${P(r.minArgs)} for \${e}(), got \${A.length}\`);if(A.length>r.maxArgs)throw new Error(\`Expected at most \${r.maxArgs} \${P(r.maxArgs)} for \${e}(), got \${A.length}\`);return new Promise((u,d)=>{if(r.fallbackToNoCallback)try{t[e](...A,q({resolve:u,reject:d},r))}catch(s){console.warn(\`\${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: \`,s),t[e](...A),r.fallbackToNoCallback=!1,r.noCallback=!0,u()}else r.noCallback?(t[e](...A),u()):t[e](...A,q({resolve:u,reject:d},r))})},D=(e,r,n)=>new Proxy(r,{apply(t,A,u){return n.call(A,e,...u)}});let M=Function.call.bind(Object.prototype.hasOwnProperty);const I=(e,r={},n={})=>{let t=Object.create(null),A={has(d,s){return s in e||s in t},get(d,s,f){if(s in t)return t[s];if(!(s in e))return;let o=e[s];if(typeof o==\\"function\\")if(typeof r[s]==\\"function\\")o=D(e,e[s],r[s]);else if(M(n,s)){let y=se(s,n[s]);o=D(e,e[s],y)}else o=o.bind(e);else if(typeof o==\\"object\\"&&o!==null&&(M(r,s)||M(n,s)))o=I(o,r[s],n[s]);else if(M(n,\\"*\\"))o=I(o,r[s],n[\\"*\\"]);else return Object.defineProperty(t,s,{configurable:!0,enumerable:!0,get(){return e[s]},set(y){e[s]=y}}),o;return t[s]=o,o},set(d,s,f,o){return s in t?t[s]=f:e[s]=f,!0},defineProperty(d,s,f){return Reflect.defineProperty(t,s,f)},deleteProperty(d,s){return Reflect.deleteProperty(t,s)}},u=Object.create(e);return new Proxy(u,A)},_=e=>({addListener(r,n,...t){r.addListener(e.get(n),...t)},hasListener(r,n){return r.hasListener(e.get(n))},removeListener(r,n){r.removeListener(e.get(n))}}),ne=new B(e=>typeof e!=\\"function\\"?e:function(n){const t=I(n,{},{getContent:{minArgs:0,maxArgs:0}});e(t)}),W=new B(e=>typeof e!=\\"function\\"?e:function(n,t,A){let u=!1,d,s=new Promise(T=>{d=function(b){u=!0,T(b)}}),f;try{f=e(n,t,d)}catch(T){f=Promise.reject(T)}const o=f!==!0&&re(f);if(f!==!0&&!o&&!u)return!1;const y=T=>{T.then(b=>{A(b)},b=>{let L;b&&(b instanceof Error||typeof b.message==\\"string\\")?L=b.message:L=\\"An unexpected error occurred\\",A({__mozWebExtensionPolyfillReject__:!0,message:L})}).catch(b=>{console.error(\\"Failed to send onMessage rejected reply\\",b)})};return y(o?f:s),!0}),te=({reject:e,resolve:r},n)=>{v.runtime.lastError?v.runtime.lastError.message===w?r():e(new Error(v.runtime.lastError.message)):n&&n.__mozWebExtensionPolyfillReject__?e(new Error(n.message)):r(n)},U=(e,r,n,...t)=>{if(t.length<r.minArgs)throw new Error(\`Expected at least \${r.minArgs} \${P(r.minArgs)} for \${e}(), got \${t.length}\`);if(t.length>r.maxArgs)throw new Error(\`Expected at most \${r.maxArgs} \${P(r.maxArgs)} for \${e}(), got \${t.length}\`);return new Promise((A,u)=>{const d=te.bind(null,{resolve:A,reject:u});t.push(d),n.sendMessage(...t)})},ie={devtools:{network:{onRequestFinished:_(ne)}},runtime:{onMessage:_(W),onMessageExternal:_(W),sendMessage:U.bind(null,\\"sendMessage\\",{minArgs:1,maxArgs:3})},tabs:{sendMessage:U.bind(null,\\"sendMessage\\",{minArgs:2,maxArgs:3})}},F={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return R.privacy={network:{\\"*\\":F},services:{\\"*\\":F},websites:{\\"*\\":F}},I(v,ie,R)};a.exports=ee(chrome)}else a.exports=globalThis.browser})})(O);var K=O.exports;const J=H(K);function C(i,...p){if(typeof p[0]==\\"string\\"){const a=p.shift();i(\`[wxt] \${a}\`,...p)}else i(\\"[wxt]\\",...p)}var j={debug:(...i)=>C(console.debug,...i),log:(...i)=>C(console.log,...i),warn:(...i)=>C(console.warn,...i),error:(...i)=>C(console.error,...i)},Q=J,X=(h=class extends AbortController{constructor(a){super();N(this,E);N(this,S);N(this,k,window.self===window.top);this.contentScriptName=a,Z(this,k)&&$(this,E,z).call(this),this.setTimeout(()=>{$(this,S,Y).call(this)})}get isInvalid(){return Q.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(a){return this.signal.addEventListener(\\"abort\\",a),()=>this.signal.removeEventListener(\\"abort\\",a)}setInterval(a,c){const x=setInterval(()=>{this.isValid&&a()},c);return this.onInvalidated(()=>clearInterval(x)),x}setTimeout(a,c){const x=setTimeout(()=>{this.isValid&&a()},c);return this.onInvalidated(()=>clearTimeout(x)),x}requestAnimationFrame(a){const c=requestAnimationFrame((...x)=>{this.isValid&&a(...x)});return this.onInvalidated(()=>cancelAnimationFrame(c)),c}requestIdleCallback(a,c){const x=requestIdleCallback((...w)=>{this.signal.aborted||a(...w)},c);return this.onInvalidated(()=>cancelIdleCallback(x)),x}notifyInvalidated(){this.abort(\\"Content script context invalidated\\"),j.debug(\`\${this.contentScriptName} invalidated\`)}},k=new WeakMap,E=new WeakSet,z=function(){window.postMessage({event:h.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName})},S=new WeakSet,Y=function(){const a=c=>{var x,w;((x=c.data)==null?void 0:x.type)===h.SCRIPT_STARTED_MESSAGE_TYPE&&((w=c.data)==null?void 0:w.contentScriptName)===this.contentScriptName&&this.notifyInvalidated()};addEventListener(\\"message\\",a),this.onInvalidated(()=>removeEventListener(\\"message\\",a))},G(h,\\"SCRIPT_STARTED_MESSAGE_TYPE\\",\\"wxt:content-script-started\\"),h);(async()=>{try{const i=new X(\\"overlay-one\\");await g.main(i)}catch(i){j.error(\\"The content script crashed on startup!\\",i)}})()})();

      ================================================================================
      .output/chrome-mv3/manifest.json
      ----------------------------------------
      {\\"manifest_version\\":3,\\"name\\":\\"E2E Extension\\",\\"description\\":\\"Example description\\",\\"version\\":\\"0.0.0\\",\\"version_name\\":\\"0.0.0-test\\",\\"content_scripts\\":[{\\"matches\\":[\\"*://*/*\\"],\\"js\\":[\\"content-scripts/overlay-one.js\\"]}]}"
    `);
  });

  it('should not include an entrypoint if the target browser is not in the list of included targets', async () => {
    const project = new TestProject();
    project.addFile('entrypoints/options.html', '<html></html>');
    project.addFile(
      'entrypoints/background.ts',
      `
          export default defineBackground({
            include: ["chrome"],
            main() {},
          })
        `,
    );

    await project.build({ browser: 'firefox' });

    expect(await project.fileExists('.output/firefox-mv2/background.js')).toBe(
      false,
    );
  });

  it('should not include an entrypoint if the target browser is in the list of excluded targets', async () => {
    const project = new TestProject();
    project.addFile('entrypoints/options.html', '<html></html>');
    project.addFile(
      'entrypoints/background.ts',
      `
          export default defineBackground({
            exclude: ["chrome"],
            main() {},
          })
        `,
    );

    await project.build({ browser: 'chrome' });

    expect(await project.fileExists('.output/firefox-mv2/background.js')).toBe(
      false,
    );
  });
});
